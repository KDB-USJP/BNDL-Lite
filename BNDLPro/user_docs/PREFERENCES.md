# BNDL Preference System

This addon implements a three-tier preference management system similar to enterprise software configuration:

## Preference Loading Order

1. **Studio Preferences** (via `studio_prefs_location.json` pointer)
   - Admin-defined defaults for studio/team environments
   - Pointer file in addon root references centralized studio_prefs.json
   - Allows preference updates without addon redeployment
   - Optional - if not present, falls back to user prefs

2. **User Preferences** (`bndl_user_prefs.json` in Blender config)
   - User-specific overrides
   - Location: `<Blender Config>/BNDL/bndl_user_prefs.json`
   - Windows example: `C:\Users\<username>\AppData\Roaming\Blender Foundation\Blender\4.5\config\BNDL\bndl_user_prefs.json`
   - Saved via "Save User Preferences" button in addon preferences

3. **Default Preferences** (hardcoded)
   - Built-in fallback if neither studio nor user prefs exist
   - Defined in `pref_manager.py` PREF_SCHEMA

## For Studio Administrators

### Two-File System

BNDL uses a pointer system to enable centralized preference management:

1. **`studio_prefs_location.json`** (in addon root) - Points to actual preferences
2. **`studio_prefs.json`** (on network/shared location) - Contains actual preference values

This architecture allows you to:
- Update studio preferences without redeploying the addon to every workstation
- Maintain a single source of truth for studio settings
- Version control studio preferences separately from addon code

### Setup Instructions

#### Step 1: Create Central Studio Preferences

1. Copy `examples/studio_prefs.json.example` to a central network location
   - Example: `//fileserver/studio_assets/blender/bndl/studio_prefs.json`
   - Or: `Z:\studio_assets\blender\bndl\studio_prefs.json`

2. Edit the file with your studio's default settings

```json
{
  "bndl_directories": [
    {
      "name": "Feature Film Project",
      "directory": "//fileserver/studio_assets/film/bndl_library"
    },
    {
      "name": "Commercial Work", 
      "directory": "//fileserver/studio_assets/commercial/bndl_assets"
    }
  ],
  "name_prefix_1": "STUDIO",
  "overall_notes": "Generated by Studio Pipeline\nContact: pipeline@studio.com",
  "round_float_precision": true,
  "asset_dependency_mode": "APPEND_ASSETS",
  "pack_assets_on_export": true,
  "allow_file_delete": false
}
```

#### Step 2: Create Pointer File

1. Copy `examples/studio_prefs_location.json.example` to addon root as `studio_prefs_location.json`

2. Edit to point to your central studio prefs:

```json
{
  "studio_prefs_path": "//fileserver/studio_assets/blender/bndl/studio_prefs.json"
}
```

**Supported Path Formats:**
- **Network UNC**: `//fileserver/share/path/studio_prefs.json`
- **Absolute**: `Z:/studio_assets/blender/bndl/studio_prefs.json`
- **Blender Relative**: `//studio_assets/bndl/studio_prefs.json` (relative to current .blend file)

#### Step 3: Deploy

1. Include `studio_prefs_location.json` with addon when deploying to workstations
2. Users will automatically load studio preferences on addon startup
3. Update `studio_prefs.json` on the network - changes apply on next Blender restart

### Updating Studio Preferences

1. Edit the central `studio_prefs.json` file
2. Users get updates automatically on next Blender restart
3. No addon redeployment needed! üéâ
```json
{
  "bndl_directories": [
    {"name": "Studio Library", "directory": "//studio_assets/bndl_exports"}
  ],
  "name_prefix_1": "STUDIO",
  "overall_notes": "Generated by Studio Pipeline",
  "round_float_precision": true,
  "asset_dependency_mode": "APPEND_ASSETS"
}
```

## For Users

### Saving Your Preferences
1. Open Blender Preferences ‚Üí Add-ons ‚Üí BNDL Tools
2. Configure settings as desired
3. Click "Save User Preferences"
4. Your settings are now saved and will persist across Blender sessions

### Resetting to Defaults
- Click "Reset to Studio/Defaults" to discard your changes
- If studio prefs exist, resets to those
- Otherwise, resets to hardcoded defaults

### Deleting User Preferences
- Click "Delete User Preferences" to remove your saved settings file
- This will reset you back to studio/default preferences
- Requires confirmation

## Available Preferences

### Project Management
- `bndl_directories`: Array of project directories with name/path pairs for organizing .bndl libraries

### Export Settings
- `name_prefix_1`, `name_prefix_2`: Filename prefixes for exports
- `name_suffix_1`: Filename suffix for exports
- `overall_notes`: Prepended to every .bndl as comments
- `keep_replay_text`: Keep generated replay scripts for inspection
- `round_float_precision`: Round floats to 3 decimal places

### Asset Handling
- `asset_dependency_mode`: How to handle referenced assets ("NONE", "PROXIES", "APPEND_ASSETS")
- `reuse_proxies`: Reuse proxy datablocks for missing assets
- `pack_assets_on_export`: Pack images/textures into exports
- `asset_pack_format`: Format for packed assets ("BNDLPACK", "BLEND", "HYBRID")
- `auto_unpack_assets_on_replay`: Auto-unpack assets when replaying

### Safety & Performance
- `allow_file_delete`: Allow users to delete .bndl files from browser
- `max_recent_files`: Maximum number of recent files to track (3-50)

## Technical Details

- **Preference source** displayed in addon preferences panel
- **Icons** indicate current source: üè¢ Studio, üë§ User, ‚öôÔ∏è Default
- **JSON files** use UTF-8 encoding with 2-space indentation
- **Invalid/malformed JSON** files are ignored with console warnings
- **Preferences loaded once** on addon registration
- **User preferences** saved immediately when "Save" is clicked
- **Studio prefs pointer** supports network paths, absolute paths, and Blender-relative (//) paths
- **Blender-relative paths** (`//...`) resolve relative to currently open .blend file
- **Network paths** work with UNC format: `//server/share/path`
